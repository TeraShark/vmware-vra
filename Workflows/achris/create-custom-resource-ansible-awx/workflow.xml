<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<ns2:workflow xmlns:ns2="http://vmware.com/vco/workflow" root-name="item12" object-name="workflow:name=generic" id="a487f857-eb74-45de-9a25-67b460d5aa07" editor-version="2.0" version="0.1.0" api-version="6.0.0" allowed-operations="vef" restartMode="1" resumeFromFailedMode="0">
    <display-name>create-custom-resource-ansible-awx</display-name>
    <description>Workflow for Dynamic Types Creation (for Ansible AWX mediation) which creates all workflows for the Type and injects the Custom Resource into vRA. JSON input is a specific schema related to Ansible AWX.</description>
    <position y="50.0" x="120.0"/>
    <input>
        <param name="json" type="string"/>
    </input>
    <output/>
    <attrib name="namespaceRef" type="DynamicTypes:DynamicNamespaceDefinition">
        <value encoded="n"/>
    </attrib>
    <attrib name="token" type="string">
        <value encoded="n"></value>
    </attrib>
    <attrib name="wfid_update" type="string">
        <value encoded="n">bb3b44ee-fe9c-43fa-a246-2d4d98c1a1d4</value>
    </attrib>
    <attrib name="wfid_create" type="string">
        <value encoded="n">597baeeb-abfa-43e0-87ae-eaca6a4ef8d8</value>
    </attrib>
    <attrib name="wfid_delete" type="string">
        <value encoded="n">aa71e7d6-22d8-42b9-9794-f52d0c43309f</value>
    </attrib>
    <attrib name="icon" type="ResourceElement">
        <value encoded="n">dunes://service.dunes.ch/ResourceElement?id='ccc63028-0b79-48ad-bf8d-4078a2d058ce'&amp;dunesName='ResourceElement'</value>
    </attrib>
    <attrib name="workflowStubsCategory" type="WorkflowCategory">
        <value encoded="n">dunes://service.dunes.ch/WorkflowCategory?id='8a74805971f49d72017219ad7dfe0273'&amp;dunesName='WorkflowCategory'</value>
    </attrib>
    <attrib name="day2opWorkflows" type="Any">
        <value encoded="n"/>
    </attrib>
    <attrib name="namespace" type="string">
        <value encoded="n"></value>
        <description>eg: com.company.types</description>
    </attrib>
    <attrib name="configurations" type="Array/ConfigurationElement">
        <value encoded="n">[]</value>
    </attrib>
    <attrib name="vROServer" type="Any">
        <value encoded="n"/>
    </attrib>
    <attrib name="vRAServer" type="Any">
        <value encoded="n"/>
    </attrib>
    <attrib name="finderWorkflowIDs" type="Properties">
        <value encoded="n">#[##]#</value>
        <description>typeName: [IDs]</description>
    </attrib>
    <attrib name="payload" type="Any">
        <value encoded="n"/>
    </attrib>
    <attrib name="actionResult" type="string">
        <value encoded="n"></value>
    </attrib>
    <workflow-item name="item0" type="end" end-mode="0" comparator="0">
        <in-binding/>
        <out-binding/>
        <position y="110.0" x="120.0"/>
    </workflow-item>
    <workflow-item name="item8" out-name="item0" type="task" comparator="0">
        <display-name>Create vRA Resource</display-name>
        <script encoded="false">//https://cava-6-240-202.eng.vmware.com/form-service/api/custom/resource-types
///form-service/api/custom/resource-types
var payload = {
  "displayName": typeName,
  "description": namespace + "." + typeName,
  "resourceType": "Custom." + typeName,
  "externalType": "DynamicTypes:" + namespace + "." + typeName,
  "status": "RELEASED",
  "properties": {
    "type": "object",
    "properties": {
      "input_0": {
        "type": "string",
        "title": "First input for the creation of your custom type"
      }
    },
    "required": [
    ]
  },
  "additionalActions": [],
  "mainActions": {
    "create": {
      "id": wfid_create,
      "name": "Create " + namespace + "." + typeName,
      "description": "Auto-generated Workflow",
      "type": "vro.workflow",
      "endpointLink": "/resources/endpoints/522d727b-54a9-49bc-93cc-6f5e0a8bdb98"
    },
    "update": {
      "id": wfid_update,
      "name": "Update " + namespace + "." + typeName,
      "description": "Auto-generated Workflow",
      "type": "vro.workflow",
      "endpointLink": "/resources/endpoints/522d727b-54a9-49bc-93cc-6f5e0a8bdb98"
    },
    "delete": {
      "id": wfid_delete,
      "name": "Delete " + namespace + "." + typeName,
      "description": "Auto-generated Workflow",
      "type": "vro.workflow",
      "endpointLink": "/resources/endpoints/522d727b-54a9-49bc-93cc-6f5e0a8bdb98"
    }
  }
}

var props = {};
for each (var prop in typeProperties){
    props[prop] = {
        "type": "string",
        "title": prop
      };
}

payload.properties.properties = props;

for each(var wf in day2opWorkflows){
    payload.additionalActions.push({
      "displayName": wf.displayName,
      "name": wf.name,
      "runnableItem": {
        "id": wf.id,
        "name": wf.name,
        "description": wf.name,
        "type": "vro.workflow",
        "endpointLink": "/resources/endpoints/522d727b-54a9-49bc-93cc-6f5e0a8bdb98"
      }
    });
}

var RestHostFactory = System.getModule("com.vmware.pscoe.library.rest").RestHostFactory();
var RestClient = System.getModule("com.vmware.pscoe.library.rest").RestClient();


var endpointUrl = "https://cava-6-240-202.eng.vmware.com";
var endpointName = "vRA";
var requestContent = {};
requestContent.username = "configadmin";
requestContent.password = "VMware1!";

var restHost = RestHostFactory.newHostWithBasicAuth(endpointUrl, endpointName, requestContent.username, requestContent.password); 
var restClient = new RestClient(restHost);

var request = {
    path: '/form-service/api/custom/resource-types',
    params: [],
    content: payload,
    options: {
        skipEncodeParams: true,	
        returnResponseObject: true,		
        returnResponseObjectForReal: false, 	
        stringifyJsonContent: true,	
        interpretResponseCode: false,	
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'Authorization': 'Bearer ' + token
        },
        errorHandler: {					//Defines a retry mechanism in case of failed requests
            numberOfRetries: 3,			//Number of retries
            retryWaitInterval: 15,			//Polling interval in seconds
            errorsToRetry: ["Read timed out"]	//Specific errors to retry (Default: ["Connection pool shut down"])
        }
    }
};
System.debug("Creating Custom Resource via API...");
//var urlTemplate = "workflows/{id}";
System.debug(JSON.stringify(payload));

var httpData = restClient.post(request.path, request.params, request.content, request.options);
if (httpData.statusCode != 200){
    throw "Error calling API. Received Status Code: " + httpData.statusCode;
}
</script>
        <in-binding>
            <bind name="token" type="string" export-name="token"/>
            <bind name="typeName" type="string"/>
            <bind name="wfid_create" type="string" export-name="wfid_create"/>
            <bind name="wfid_update" type="string" export-name="wfid_update"/>
            <bind name="wfid_delete" type="string" export-name="wfid_delete"/>
            <bind name="namespace" type="string" export-name="namespace"/>
            <bind name="typeProperties" type="Array/string"/>
            <bind name="day2opWorkflows" type="Any" export-name="day2opWorkflows"/>
        </in-binding>
        <out-binding/>
        <description>Simple task with custom script capability.</description>
        <position y="170.0" x="180.0"/>
    </workflow-item>
    <workflow-item name="item9" out-name="item15" type="task" comparator="0">
        <display-name>Create Namespace</display-name>
        <script encoded="false">// Validate input values
if (namespace == null || namespace.trim().length == 0) {
  throw "Undefined namespace: namespace cannot be null or empty";
}
var namespaceDef = DynamicTypesManager.getNamespace(namespace);
// Define namespace
if (!namespaceDef){
  namespaceDef = DynamicTypesManager.defineNamespace(namespace);
  System.log("Created dynamic namespace: " + namespaceDef);
} 

namespaceRef = namespaceDef;</script>
        <in-binding>
            <bind name="namespace" type="string" export-name="namespace"/>
        </in-binding>
        <out-binding>
            <bind name="namespaceRef" type="DynamicTypes:DynamicNamespaceDefinition" export-name="namespaceRef"/>
        </out-binding>
        <description>Simple task with custom script capability.</description>
        <position y="60.0" x="420.0"/>
    </workflow-item>
    <workflow-item name="item12" out-name="item13" type="task" comparator="0">
        <display-name>parse JSON</display-name>
        <script encoded="false">var p = JSON.parse(json);

namespace = p.namespace;
vROServer = p.vROServer;
vRAServer = p.vRAServer;

p.types.forEach(function(type){
   type = cleanType(type);
});

function cleanType(type){
    if(type.typeProperties){
        var index = 0;
        type.typeProperties.forEach(function(prop){
            if (prop.toLowerCase() == "id")
                type.typeProperties.splice(index, 1);
            else
                index++;
        });
    }
    if(type.AWXJobTemplates){
        type.AWXJobTemplates.forEach(function(template){
            template.extra_vars.forEach(function(v){
                if(v.inputReference.toLowerCase() == "id")
                    v.inputReference = "id";
            });
            var idDefined = false;
            template.outputMapping.forEach(function(o){
                if(o.typeReference.toLowerCase() == "id"){
                    o.typeReference = "id";
                    idDefined = true;
                }
            });
            if (!idDefined &amp;&amp; template.event == "create"){
                System.error("You must specify an outputMapping for field 'id' on a 'create' event for any types you define");
                throw "Missing outputMapping in 'create' event for mandatory field 'id' on type: " + type.typeName;
            }
        });
    }
    return type;
}

payload = p;

System.debug("Parsed JSON...");</script>
        <in-binding>
            <bind name="json" type="string" export-name="json"/>
        </in-binding>
        <out-binding>
            <bind name="namespace" type="string" export-name="namespace"/>
            <bind name="vROServer" type="Any" export-name="vROServer"/>
            <bind name="vRAServer" type="Any" export-name="vRAServer"/>
            <bind name="payload" type="Any" export-name="payload"/>
        </out-binding>
        <description>Simple task with custom script capability.</description>
        <position y="60.0" x="187.27272727272725"/>
    </workflow-item>
    <workflow-item name="item13" out-name="item9" type="task" comparator="0">
        <display-name>Define Endpoints</display-name>
        <script encoded="false">
payload.types[0].isSuppliedRoot = true;
payload.types[0].parentType = "Endpoint";


System.debug("Defining inherent parent base type: Endpoint...");
var baseType = { "typeName": "Endpoint",
        "containerName": "Endpoints",
        "isBaseType": true,
        "typeProperties": [],
        "childTypes": payload.types };

payload.types = [baseType];

setParentTypes(payload.types, null);

//System.debug(JSON.stringify(payload.types));

var category = namespace + ".Endpoints";

var ansibleServers = payload.AnsibleServers;
System.debug("Iterating [" + ansibleServers.length + "] Ansible endpoints...");

ansibleServers.forEach(function(server){
    try{
        var elem = Server.createConfigurationElement(category, server.EndpointName);
        
        Object.keys(server).forEach(function(key){
            var typeHint = "string";
            if(key == "password" || key == "authKey")
                typeHint = "SecureString";

            elem.setAttributeWithKey(key, server[key], typeHint);
        });
        System.debug("Created Configuration: " + server.EndpointName);
    }
    catch(e){
        System.error("Unable to create Configuration: " + e.message);
    }
});


function setParentTypes(types, parent){
    types.forEach(function(type){
        if(parent != null)
            type.parentType = parent;
        if(type.childTypes != null){
            setParentTypes(type.childTypes, type.typeName);
        }
    });
}

/*{ //Sample Server:
    "EndpointName": "UK-PROD",
    "host": "https://ansible-01a.ukprod.corp.local",
    "username": "",
    "password": "",
    "authType": "oauth",
    "authKey": "b6r4q31caadgnwatjj7e7wrva6rh7jt"
}*/

</script>
        <in-binding>
            <bind name="namespace" type="string" export-name="namespace"/>
            <bind name="payload" type="Any" export-name="payload"/>
        </in-binding>
        <out-binding>
            <bind name="configurations" type="Array/ConfigurationElement" export-name="configurations"/>
            <bind name="payload" type="Any" export-name="payload"/>
        </out-binding>
        <description>Simple task with custom script capability.</description>
        <position y="60.0" x="300.0"/>
    </workflow-item>
    <workflow-item name="item14" out-name="item8" type="task" comparator="0">
        <display-name>vRA Auth Token</display-name>
        <script encoded="false">
var RestHostFactory = System.getModule("com.vmware.pscoe.library.rest").RestHostFactory();
var RestClient = System.getModule("com.vmware.pscoe.library.rest").RestClient();


var endpointUrl = vRAServer.FQDN;
var endpointName = "vRA";
var requestContent = {};
requestContent.username = vRAServer.adminUserName;
requestContent.password = vRAServer.adminPassword;

var restHost = RestHostFactory.newHostWithBasicAuth(endpointUrl, endpointName, requestContent.username, requestContent.password); 
var restClient = new RestClient(restHost);

var request = {
    path: '/csp/gateway/am/api/login?access_token=',
    params: [],
    content: JSON.stringify(requestContent),
    options: {
        skipEncodeParams: true,	
        returnResponseObject: true,		
        returnResponseObjectForReal: false, 	
        stringifyJsonContent: false,	
        interpretResponseCode: false,	
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        errorHandler: {					//Defines a retry mechanism in case of failed requests
            numberOfRetries: 3,			//Number of retries
            retryWaitInterval: 15,			//Polling interval in seconds
            errorsToRetry: ["Read timed out"]	//Specific errors to retry (Default: ["Connection pool shut down"])
        }
    }
};
System.debug("Calling vRA API...");
//var urlTemplate = "workflows/{id}";

var httpData = restClient.post(request.path, request.params, request.content, request.options);
if (httpData.statusCode != 200){
    throw "Error calling API. Received Status Code: " + httpData.statusCode;
}
var access_token = JSON.parse(httpData.contentAsString).access_token;
token = access_token;

</script>
        <in-binding>
            <bind name="vRAServer" type="Any" export-name="vRAServer"/>
        </in-binding>
        <out-binding>
            <bind name="token" type="string" export-name="token"/>
        </out-binding>
        <description>Simple task with custom script capability.</description>
        <position y="170.0" x="300.0"/>
    </workflow-item>
    <workflow-item name="item15" out-name="item0" type="task" script-module="com.vmware.pso.types.ansible/generateAWXMediation" comparator="0">
        <display-name>Do Magic Stuff</display-name>
        <script encoded="false">//Auto generated script, cannot be modified !
actionResult = System.getModule("com.vmware.pso.types.ansible").generateAWXMediation(icon,namespaceDefinition,json,workflowStubsCategory);
</script>
        <in-binding>
            <bind name="icon" type="ResourceElement" export-name="icon">
                <description></description>
            </bind>
            <bind name="namespaceDefinition" type="DynamicTypes:DynamicNamespaceDefinition" export-name="namespaceRef">
                <description></description>
            </bind>
            <bind name="json" type="Any" export-name="payload">
                <description></description>
            </bind>
            <bind name="workflowStubsCategory" type="WorkflowCategory" export-name="workflowStubsCategory">
                <description></description>
            </bind>
        </in-binding>
        <out-binding>
            <bind name="actionResult" type="string" export-name="actionResult"/>
        </out-binding>
        <description>Add a note to the workflow schema.</description>
        <position y="120.0" x="420.0"/>
    </workflow-item>
    <presentation>
        <p-param name="json">
            <desc>json</desc>
        </p-param>
    </presentation>
</ns2:workflow>
